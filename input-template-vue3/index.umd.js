(function(E,p){typeof exports=="object"&&typeof module<"u"?p(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],p):(E=typeof globalThis<"u"?globalThis:E||self,p(E["input-template-vue3"]={},E.Vue))})(this,function(E,p){"use strict";const A=((g,y)=>{const L=g.__vccOpts||g;for(const[S,O]of y)L[S]=O;return L})({__name:"index",props:{elements:{type:Array,default:()=>[]},showTemplate:{type:Boolean,default:!0}},emits:["change","submit"],setup(g,{expose:y,emit:L}){const S=g,O=L,i=p.ref(null),_=p.ref("");p.ref([]),p.ref(-1);const $=e=>{const a=document.createElement("div");a.innerHTML=e;const n=s=>{var o,r,f,T,d;if(s.nodeType===3)return s.textContent;if((o=s.classList)!=null&&o.contains("editable-div"))return s.textContent||"";if((r=s.classList)!=null&&r.contains("custom-select")){const u=s.querySelector(".select-option.selected");return u?u.textContent:""}if(s.tagName==="SELECT")return((f=s.options[s.selectedIndex])==null?void 0:f.text)||"";if(s.tagName==="INPUT"){const u=(d=i.value)==null?void 0:d.querySelector(`[data-id="${(T=s.closest("[data-id]"))==null?void 0:T.dataset.id}"] input`);return u?u.value||"":s.value||""}let l="";for(const u of s.childNodes)l+=n(u);return l};return n(a).replace(/\s+/g," ").trim()},x=e=>{_.value=e;const a=$(e);console.log("纯文本内容:",a),k.value=a},V=e=>{e.preventDefault();const a=$(_.value);console.log("纯文本内容:",a),O("submit",a)},X=e=>{const a=i.value.innerHTML;(!a||a.trim()===""||a==="<br>"||a.replace(/&nbsp;/g,"").trim()==="")&&(i.value.innerHTML=""),i.value.querySelectorAll(".editable-div").forEach(t=>{t.textContent.trim()===""?t.classList.add("showing-placeholder"):t.classList.remove("showing-placeholder")}),x(a)},K=e=>{const a=e.target.closest(".element-placeholder");if(a){const n=a.dataset.id;j(n)}},U=e=>{var a,n,t,s;if(!((e.ctrlKey||e.metaKey)&&e.key==="z")){if(e.key==="Backspace"||e.key==="Delete"){const l=window.getSelection();if(!l.rangeCount)return;const o=l.getRangeAt(0),r=o.startContainer,f=o.startOffset;console.log("删除操作:",{key:e.key,startNodeType:r.nodeType,startNodeName:r.nodeName,startNodeContent:r.textContent,startOffset:f,previousSibling:r.previousSibling?r.previousSibling.nodeName:"none"});let T=!1,d=null,u=r;for(;u&&u!==i.value;){if(u.classList&&u.classList.contains("editable-div")){T=!0,d=u;break}u=u.parentNode}if(T){if(e.key==="Backspace"&&(d.textContent.length===1||o.startOffset===1&&o.startOffset===o.endOffset)||e.key==="Delete"&&(d.textContent.length===1||o.startOffset===0&&o.startOffset===o.endOffset&&d.textContent.length===1)){e.preventDefault(),d.textContent="",d.classList.add("showing-placeholder");const c=document.createRange();c.setStart(d,0),c.collapse(!0),l.removeAllRanges(),l.addRange(c),x(i.value.innerHTML);return}if(d.textContent.trim()===""&&d.classList.contains("showing-placeholder")&&(e.key==="Backspace"||e.key==="Delete")){setTimeout(()=>{const c=d.closest(".input-wrapper");if(c&&c.parentNode){const m=window.getSelection(),v=document.createRange();v.selectNode(c),m.removeAllRanges(),m.addRange(v),document.execCommand("insertText",!1,"");const b=document.createTextNode("​");c.parentNode.insertBefore(b,c.nextSibling),c.remove();const w=document.createRange();w.setStart(b,0),w.collapse(!0),m.removeAllRanges(),m.addRange(w),document.execCommand("insertText",!1,""),x(i.value.innerHTML)}},0);return}return}if(e.key==="Backspace"&&r.nodeType===Node.TEXT_NODE&&f===0){let h=r.previousSibling;for(;h&&h.nodeType===Node.TEXT_NODE&&h.textContent.trim()==="";)h=h.previousSibling;if(h&&h.nodeType===Node.ELEMENT_NODE&&(h.classList.contains("input-wrapper")||h.classList.contains("select-wrapper"))){const c=h.querySelector(".editable-div");if(c&&c.textContent.trim()===""&&c.classList.contains("showing-placeholder")){e.preventDefault();const v=h,b=window.getSelection(),w=document.createRange();w.selectNode(v),b.removeAllRanges(),b.addRange(w),document.execCommand("insertText",!1,"");const R=document.createTextNode("​");v.parentNode.insertBefore(R,v.nextSibling),v.remove();const N=document.createRange();N.setStart(R,0),N.collapse(!0),b.removeAllRanges(),b.addRange(N),document.execCommand("insertText",!1,""),x(i.value.innerHTML);return}setTimeout(()=>{const v=window.getSelection();if(!v.rangeCount)return;let w=v.getRangeAt(0).startContainer,R=!1,N=null;for(;w&&w!==i.value;){if(w.classList&&w.classList.contains("editable-div")){R=!0,N=w;break}w=w.parentNode}if(R){const H=N.closest(".input-wrapper");if(H){document.execCommand("insertText",!1,"");const q=document.createTextNode("​");H.parentNode.insertBefore(q,H.nextSibling);const M=document.createRange();M.setStart(q,0),M.collapse(!0),v.removeAllRanges(),v.addRange(M),document.execCommand("insertText",!1,"")}}x(i.value.innerHTML)},0);return}}if(e.key==="Delete"&&(r.nodeType===Node.TEXT_NODE&&f===r.textContent.length||r.nodeType===Node.TEXT_NODE&&r.textContent.trim()==="")){let c=r.nextSibling;for(;c&&c.nodeType===Node.TEXT_NODE&&c.textContent.trim()==="";)c=c.nextSibling;if(c&&c.nodeType===Node.ELEMENT_NODE&&c.classList.contains("input-wrapper")){const m=c.querySelector(".editable-div");if(m){e.preventDefault(),c.setAttribute("contenteditable","false"),m.focus();const v=window.getSelection(),b=document.createRange();m.firstChild&&m.firstChild.nodeType===Node.TEXT_NODE?b.setStart(m.firstChild,0):b.setStart(m,0),b.collapse(!0),v.removeAllRanges(),v.addRange(b),console.log("Del 键处理: 光标已设置到 editable-div",{editableDiv:m,focused:document.activeElement===m}),setTimeout(()=>{document.activeElement!==m&&c.setAttribute("contenteditable","true")},300),x(i.value.innerHTML);return}}}}if(e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="ArrowUp"||e.key==="ArrowDown"){const l=window.getSelection(),o=l.getRangeAt(0),r=((n=(a=o.startContainer).closest)==null?void 0:n.call(a,".custom-select"))||((s=(t=o.startContainer.parentElement)==null?void 0:t.closest)==null?void 0:s.call(t,".custom-select"));if(r){e.preventDefault();const T=r.closest(".select-wrapper"),d=document.createRange();e.key==="ArrowRight"?d.setStartAfter(T):e.key==="ArrowLeft"&&d.setStartBefore(T),d.collapse(!0),l.removeAllRanges(),l.addRange(d);return}const f=document.activeElement;if(i.value.contains(f)&&f.classList.contains("editable-div")){if(e.key==="ArrowLeft"){if(o.startOffset===0){e.preventDefault();const d=f.closest(".input-wrapper").previousElementSibling;if(d){const u=document.createRange();u.setStartAfter(d),u.collapse(!0),l.removeAllRanges(),l.addRange(u)}}}else if(e.key==="ArrowRight"&&o.endOffset===f.textContent.length){e.preventDefault();const d=f.closest(".input-wrapper").nextElementSibling;if(d){const u=document.createRange();u.setStartBefore(d),u.collapse(!0),l.removeAllRanges(),l.addRange(u)}}}}}},j=e=>{const a=S.elements.find(s=>s.id===e);if(!a)return;const n=i.value.querySelector(`[data-id="${e}"]`);if(!n)return;let t;a.type==="select"?(t=document.createElement("select"),a.options.forEach(s=>{const l=document.createElement("option");l.value=s.value,l.textContent=s.label,t.appendChild(l)}),t.value=a.value):(t=document.createElement("input"),t.type=a.type||"text",t.value=a.value),t.dataset.id=e,n.replaceWith(t),t.focus()},k=p.ref("");function B(){let e="";S.elements.forEach(a=>{const n=F(a);e+=n+" "}),i.value.innerHTML=e,k.value=$(e)}p.onMounted(()=>{S.showTemplate&&B(),i.value.addEventListener("input",n=>{const t=n.target;(t.tagName==="SELECT"||t.tagName==="INPUT"||t.classList.contains("editable-div"))&&x(i.value.innerHTML)}),i.value.querySelectorAll(".editable-div").forEach(n=>{n.textContent.trim()===""?(n.classList.add("showing-placeholder"),n.innerHTML!==""&&(n.innerHTML="")):n.classList.remove("showing-placeholder")}),i.value.addEventListener("input",n=>{const t=n.target;t.classList&&t.classList.contains("editable-div")&&(t.textContent.trim()===""?t.classList.add("showing-placeholder"):t.classList.remove("showing-placeholder"))}),i.value.addEventListener("click",n=>{const t=n.target.closest(".select-trigger");if(t){const l=t.closest(".custom-select");if(l.classList.toggle("open"),l.classList.contains("open")){const o=l.querySelector(".select-options");if(o){const r=t.getBoundingClientRect();o.style.top=`${r.bottom}px`,o.style.left=`${r.left}px`,o.style.width=`${Math.max(r.width,120)}px`;const f=o.offsetHeight||200,T=window.innerHeight;r.bottom+f>T&&(o.style.top=`${r.top-f}px`)}}}const s=n.target.closest(".select-option");if(s){const l=s.closest(".custom-select"),o=l.querySelector(".select-trigger");s.dataset.value;const r=s.textContent;l.querySelectorAll(".select-option").forEach(f=>{f.classList.remove("selected")}),s.classList.add("selected"),o.textContent=r,o.classList.remove("showing-placeholder"),l.classList.remove("open"),x(i.value.innerHTML)}}),document.addEventListener("click",n=>{n.target.closest(".custom-select")||i.value.querySelectorAll(".custom-select").forEach(t=>{t.classList.remove("open")})}),i.value.addEventListener("click",n=>{const t=n.target.closest(".input-wrapper");if(t&&!n.target.classList.contains("editable-div")){const s=t.querySelector(".editable-div");if(s){n.preventDefault(),s.focus();const l=window.getSelection(),o=document.createRange();s.lastChild&&s.lastChild.nodeType===Node.TEXT_NODE?o.setStart(s.lastChild,s.lastChild.textContent.length):o.setStart(s,s.childNodes.length),o.collapse(!0),l.removeAllRanges(),l.addRange(o)}}}),i.value.addEventListener("focusin",n=>{const t=n.target;if(t.classList&&t.classList.contains("editable-div")){const s=t.closest(".input-wrapper");s&&(s.setAttribute("contenteditable","false"),n.stopPropagation())}}),i.value.addEventListener("focusout",n=>{const t=n.target;if(t.classList&&t.classList.contains("editable-div")){const s=t.closest(".input-wrapper");s&&setTimeout(()=>{document.activeElement!==t&&s.setAttribute("contenteditable","true")},200)}}),i.value.addEventListener("keydown",n=>{if(n.key==="Backspace"){const t=n.target;if(t.classList&&t.classList.contains("editable-div")){const s=t.closest(".input-wrapper");s&&t.textContent.length<=1&&s.setAttribute("contenteditable","true")}}});const a=n=>{n.target.classList&&n.target.classList.contains("editable-div")&&n.stopPropagation()};document.addEventListener("click",a,!0),p.onUnmounted(()=>{document.removeEventListener("click",a,!0)}),G()}),p.onUnmounted(()=>{window.editorObserver&&(window.editorObserver.disconnect(),window.editorObserver=null)}),p.watch(()=>S.elements,e=>{console.log("newVal",e),S.showTemplate&&B()});const F=e=>{if(e.type==="plaintext")return e.value;if(e.type==="select"){const a=e.value&&e.options.some(t=>t.value===e.value),n=a?e.options.find(t=>t.value===e.value).label:e.placeholder||"请选择";return`<span class="select-wrapper" data-id="${e.id}" contenteditable="false">
      <div class="custom-select">
        <div class="select-trigger ${a?"":"showing-placeholder"}" 
             data-placeholder="${e.placeholder||"请选择"}">${n}</div>
        <ul class="select-options">
          ${e.options.map(t=>`<li class="select-option${t.value===e.value?" selected":""}" 
                data-value="${t.value}">${t.label}</li>`).join("")}
        </ul>
      </div>
    </span>`}else{if(e.type==="date")return`<span class="input-wrapper" data-id="${e.id}" contenteditable="false">
      <input type="${e.type||"text"}" value="${e.value}" >
    </span>`;if(e.type==="text"){const a=!e.value||e.value.trim()==="";return`<span class="input-wrapper" data-id="${e.id}" contenteditable="true">
      <div class="editable-div ${a?"showing-placeholder":""}" contenteditable="true" data-placeholder="${e.placeholder||""}">${e.value||""}</div>
    </span>`}}};y({clearInput:()=>{i.value.innerHTML="",_.value="",k.value="",x("")},initialText:k});const G=()=>{window.editorObserver||(window.editorObserver=new MutationObserver(()=>{x(i.value.innerHTML)}),window.editorObserver.observe(i.value,{childList:!0,subtree:!0,characterData:!0,attributes:!0}))},I=document.createElement("style");return I.textContent=`
  .editable-div.showing-placeholder:empty::before {
    content: attr(data-placeholder);
    color: rgba(0, 115, 229, 0.45);
    pointer-events: none;
  }
`,document.head.appendChild(I),(e,a)=>(p.openBlock(),p.createElementBlock("div",{class:"rich-editor",ref_key:"editor",ref:i,contenteditable:"true",onInput:X,onClick:K,onKeydown:[U,p.withKeys(V,["enter"])],"data-placeholder":"即刻开启创作之旅！输入需求，例如：我想要一篇[宣传文案]，主题为[智能手表]，面向[年轻群体]，风格[小红书风格]。涵盖[产品设计]、[健康监测功能]等要点。更多优质模板，点击下方即可挑选"},null,544))}},[["__scopeId","data-v-4606cd6a"]]),C=(g={})=>{const y=document.createElement("div");document.body.appendChild(y);const L=p.createApp({render(){return p.h(A,{ImgList:g.imgList||[],index:g.index||0,toolInfo:g.toolInfo||{layoutChange:!0,layout:"v",fullTool:[],clickFunc:()=>{}},onClose:()=>{L.unmount(),y.remove()}})}});return L.mount(y),{close:()=>{L.unmount(),y.remove()}}},P=[A],D={install(g){P.forEach(y=>{g.component(y.name,y)}),g.config.globalProperties.$inputTemplate=C}};if(typeof window<"u"){const g=window.Vue||window.vue||(window.Vue={});window.InputTemplates=D,g.use&&g.use(D),window.$inputTemplate=C}E.$inputTemplate=C,E.InputTemplate=A,E.default=D,Object.defineProperties(E,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
